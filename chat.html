<!doctype html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="UTF-8">
<title>Chatroom</title>
</head>
<body>
<h1>Welcome to the chatroom</h1>
<h2>Messages</h2>
<div aria-live="polite" aria-atomic="false" aria-relevant="additions text" id="output"></div>
<h2>Send A Message</h2>
<form>
<p><label>Message: <input type="text" autocomplete="off" id="input"></label></p>
<p><input type="submit" value="Send"></p>
</form>

<script>

input = document.getElementById("input")
output = document.getElementById("output")
command_match = /[/]([^ $]+)[ ]?([^$]+)?$/

functions = {
    message: (obj) => {
        let name = obj.args[0]
        let text = obj.args[1]
        write_message(`${name}: ${text}`)
        }
}

document.forms[0].onsubmit = (e) => {
    e.preventDefault()
    text = input.value
    input.value = ""
    match = text.match(command_match)
    if (match === null) {
        // Let's just send.
        send("message", [text])
    } else {
        // They want to send a command.
        let command = match[1]
        let arg = match[2]
    args = [arg]
    send(command, args)
    }
}

function write_message(text) {
    p = document.createElement("p")
    p.innerText = text
    output.appendChild(p)
}

function send(command, args, kwargs) {
    if (args === undefined) {
        args = []
    }
    if (kwargs === undefined) {
        kwargs = {}
    }
    data = JSON.stringify([command, args, kwargs])
    socket.send(data)
}

socket = new WebSocket('ws://{{ hostname }}:{{ websocket_port }}')

socket.onopen = () => {
    write_message("*** Connected ***")
}

socket.onclose = () => {
    write_message("*** Disconnected (press refresh) ***")
}

socket.onmessage = (e) => {
    let obj = JSON.parse(e.data)
    let func = functions[obj.name]
    if (func !== undefined) {
        func(obj)
    } else {
        write_message(`Unrecognised command: ${e.data}.`)
    }
}

</script>
</body>
</html>